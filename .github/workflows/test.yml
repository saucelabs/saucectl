name: Test

on:
  workflow_dispatch:
  pull_request:

env:
  SAUCE_USERNAME: ${{secrets.SAUCE_USERNAME}}
  SAUCE_ACCESS_KEY: ${{secrets.SAUCE_ACCESS_KEY}}
  BUILD_ID: saucectl-run-${{ github.run_id }}

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Lint
        uses: golangci/golangci-lint-action@v6
        with:
          args: --timeout 3m
          version: latest

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Run tests
        run: |
          go test ./...

  check-schema:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: scripts/json-schema-bundler/package-lock.json

      - name: Install Dependencies
        working-directory: scripts/json-schema-bundler
        run: npm ci

      - name: Generate Schema
        working-directory: scripts/json-schema-bundler
        run: npm run bundle -- -s ../../api/global.schema.json -o ../../api/fresh.schema.json

      - name: Check Schema
        working-directory: api/
        run: diff saucectl.schema.json fresh.schema.json

  build:
    needs: [lint, test]
    runs-on: windows-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build Project
        run: |
          SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-8)
          LDFLAG_VERSION="github.com/saucelabs/saucectl/cli/version.Version=v0.0.0+$SHORT_SHA"
          LDFLAG_SHA="github.com/saucelabs/saucectl/cli/version.GitCommit=$GITHUB_SHA"
          go install ./...
          CGO_ENABLED=0 go build -ldflags="-X $LDFLAG_VERSION -X $LDFLAG_SHA" cmd/saucectl/saucectl.go
          GOOS=windows GOARCH=amd64 go build cmd/saucectl/saucectl.go

      - name: Check GoReleaser Config
        uses: goreleaser/goreleaser-action@v5
        with:
          version: latest
          args: check

      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: saucectlbin
          path: |
            saucectl
            saucectl.exe

  cypress:
    needs: build
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download saucectl Binary
        uses: actions/download-artifact@v4
        with:
          name: saucectlbin

      - name: Saucectl RUN - Config Driven
        run: |
          ./saucectl.exe run -c .sauce/cypress-cucumber.yml --timeout 10m
